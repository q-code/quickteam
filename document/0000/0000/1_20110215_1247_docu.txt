'============
' Script: BDMGext.AvailableInView
' Date:   30 May 2001
' Author: Philippe Vandenberghe
'============
' Displays a message box with the list of fmis themes available for the current view
'============

debug = false

'------------
' Checks
'------------
vw = av.GetActiveDoc
If (vw.is(View).NOT) then MsgBox.Warning("This function requires an Airport View as active document.",Script.The.GetName) Return NIL End

B = vw.GetObjectTag.Get("B")
sBid = vw.GetObjectTag.Get("Bid")
  If (sBid=NIL) then MsgBox.Warning("This function requires an Airport View as active document.",Script.The.GetName) Return NIL End
F = vw.GetObjectTag.Get("F")
Bdir = vw.GetObjectTag.Get("Bdir")
Fdir = vw.GetObjectTag.Get("Fdir")
sBuild = vw.GetObjectTag.Get("building")
sFloor = vw.GetObjectTag.Get("floor")
sOrder = vw.GetObjectTag.Get("order")
sContext = vw.GetObjectTag.Get("context")

sPath=""
lstName={}

'-- Query --
Qry = "SELECT name,family,shp_extension FROM BDMG_symbols "
Qry = Qry + "WHERE context = '"+sContext+"' "
Qry = Qry + "ORDER BY family, name "

    if (debug) then msgbox.report(Qry,"Debug") end

  '-- connect --
   vtFMIS = av.run("BDMGext.MakeSQL",Qry)
   If (vtFMIS=NIL) then return NIL End
   If (vtFMIS.GetNumRecords=0) then MsgBox.Info("No data found. (0 data selected).","Sorry") Return NIL End
  '-- ------- --

fdName=vtFMIS.FindField("name")
fdFami=vtFMIS.FindField("family")
fdPath=vtFMIS.FindField("shp_extension")

For each rec in vtFMIS

  sFami = vtFMIS.ReturnValue(fdFami,rec).asstring
  sName = vtFMIS.ReturnValue(fdName,rec).asstring
  sPath = vtFMIS.ReturnValue(fdPath,rec).asstring

  if ( sName = "axis" ) then
    shpfilnam = _BDMGext_dir_plan + "\" + Bdir + "\" + Fdir + "\" + B + F + "_" + sPath + ".shp"
    if ( File.Exists(shpfilnam.AsFileName).not ) then
      shpfilnam = _BDMGext_dir_plan + "\" + Bdir + "\" + B + "_" + sPath + ".shp"
    end
  elseif ( sContext = "site" ) then
    shpfilnam = _BDMGext_dir_plan + "\" + Bdir + "\" + Fdir + "\" + sPath
  else
    shpfilnam = _BDMGext_dir_plan + "\" + Bdir + "\" + Fdir + "\" + B + F + "_" + sPath + ".shp"
  end
  
  If (File.Exists(shpfilnam.asFileName)) then lstName.Add(sFami+" - "+sName) End

End

msg = "Building: ["+sBid+"]"++sBuild.asstring+nl
msg = msg + "Level: ["+F+"]"++sOrder.asstring++sFloor.asstring+nl
msg = msg + "==========="+nl+nl

For each rec in lstName
  msg=msg+rec+nl
End

MsgBox.Report(msg,"List of available themes")
